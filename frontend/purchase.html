<!DOCTYPE html>
<html>
  <head>
    <title>Create Purchase</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="container mt-5">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Create Purchase</h3>
      <a href="dashboard.html" class="btn btn-secondary">
        ‚Üê Kembali ke Dashboard
      </a>
    </div>

    <!-- FORM INPUT -->
    <div class="row align-items-end">
      <div class="col-md-4">
        <label class="form-label">Supplier</label>
        <select id="supplier" class="form-control">
          <option value="">Pilih Supplier</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Item</label>
        <select id="item" class="form-control">
          <option value="">Pilih Item</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Qty</label>
        <input type="number" id="qty" class="form-control" min="1" />
      </div>

      <div class="col-md-2">
        <button id="addItem" class="btn btn-success w-100">Tambah</button>
      </div>
    </div>

    <hr />

    <!-- CART TABLE -->
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Item</th>
          <th>Harga</th>
          <th>Qty</th>
          <th>Subtotal</th>
          <th width="120">Aksi</th>
        </tr>
      </thead>
      <tbody id="cartTable">
        <tr>
          <td colspan="5" class="text-center">Belum ada item</td>
        </tr>
      </tbody>
    </table>

    <!-- GRAND TOTAL -->
    <div class="text-end mb-3">
      <h5>
        Grand Total:
        <strong id="grandTotal">Rp 0</strong>
      </h5>
    </div>

    <button id="submitOrder" class="btn btn-primary">Submit Order</button>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/app.js"></script>

    <script>
      let cart = [];

      /* ===============================
         LOAD SUPPLIER
      =============================== */
      apiRequest({
        url: "/supplier",
        success: (res) => {
          res.data.forEach((s) => {
            $("#supplier").append(`<option value="${s.id}">${s.name}</option>`);
          });
        },
      });

      /* ===============================
         LOAD ITEM (SIMPAN PRICE)
      =============================== */
      apiRequest({
        url: "/item",
        success: (res) => {
          res.data.forEach((i) => {
            $("#item").append(
              `<option value="${i.id}" data-price="${i.price}">
                ${i.name}
              </option>`
            );
          });
        },
      });

      /* ===============================
         ADD TO CART
      =============================== */
      $("#addItem").click(function () {
        const itemId = parseInt($("#item").val());
        const itemName = $("#item option:selected").text();
        const price = parseInt($("#item option:selected").data("price"));
        const qty = parseInt($("#qty").val());

        if (!itemId || !qty || qty <= 0) {
          Swal.fire("Error", "Pilih item & qty yang valid", "error");
          return;
        }

        cart.push({
          item_id: itemId,
          item_name: itemName,
          price: price,
          qty: qty,
          subtotal: price * qty,
        });

        $("#qty").val("");
        renderCart();
      });

      /* ===============================
         DELETE ITEM (EVENT DELEGATION)
      =============================== */
      $("#cartTable").on("click", ".btn-delete", function () {
        const index = $(this).data("index");
        cart.splice(index, 1);
        renderCart();
      });

      /* ===============================
         RENDER CART + GRAND TOTAL
      =============================== */
      function renderCart() {
        let rows = "";
        let total = 0;

        if (cart.length === 0) {
          $("#cartTable").html(
            `<tr><td colspan="5" class="text-center">Belum ada item</td></tr>`
          );
          $("#grandTotal").text("Rp 0");
          return;
        }

        cart.forEach((c, i) => {
          total += c.subtotal;

          rows += `
            <tr>
              <td>${c.item_name}</td>
              <td>Rp ${c.price.toLocaleString()}</td>
              <td>${c.qty}</td>
              <td>Rp ${c.subtotal.toLocaleString()}</td>
              <td>
                <button
                  class="btn btn-danger btn-sm btn-delete"
                  data-index="${i}">
                  Hapus
                </button>
              </td>
            </tr>
          `;
        });

        $("#cartTable").html(rows);
        $("#grandTotal").text("Rp " + total.toLocaleString());
      }

      /* ===============================
         SUBMIT ORDER
      =============================== */
      $("#submitOrder").click(function () {
        if (cart.length === 0) {
          Swal.fire("Error", "Keranjang masih kosong", "error");
          return;
        }

        apiRequest({
          url: "/purchasing",
          method: "POST",
          data: {
            supplier_id: parseInt($("#supplier").val()),
            grand_total: cart.reduce((t, i) => t + i.subtotal, 0),
            items: cart.map((i) => ({
              item_id: i.item_id,
              qty: i.qty,
              price: i.price,
              subtotal: i.subtotal,
            })),
          },
          success: function () {
            Swal.fire("Success", "Order berhasil disimpan", "success");
            cart = [];
            renderCart();
          },
        });
      });
    </script>
  </body>
</html>
