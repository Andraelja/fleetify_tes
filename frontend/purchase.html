<!DOCTYPE html>
<html>
  <head>
    <title>List Purchase Orders</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="container mt-5">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Data Purchase Orders</h3>
      <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#formModal" id="btnCreate">
          + Buat Purchase Baru
        </button>
        <a href="dashboard.html" class="btn btn-secondary">
          ‚Üê Kembali ke Dashboard
        </a>
      </div>
    </div>

    <!-- FILTER -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">Filter Supplier</label>
            <select id="filterSupplier" class="form-control">
              <option value="">Semua Supplier</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Filter Tanggal</label>
            <input type="date" id="filterDate" class="form-control" />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="btnFilter" class="btn btn-info me-2">Filter</button>
            <button id="btnReset" class="btn btn-secondary">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="card-body">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th width="80">No</th>
              <th>Tanggal</th>
              <th>Supplier</th>
              <th>Total Items</th>
              <th>Grand Total</th>
              <th width="180">Aksi</th>
            </tr>
          </thead>
          <tbody id="purchaseTable">
            <tr>
              <td colspan="6" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- MODAL FORM CREATE/EDIT -->
    <div class="modal fade" id="formModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="formModalTitle">Buat Purchase Baru</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- FORM INPUT -->
            <div class="row align-items-end mb-3">
              <div class="col-md-4">
                <label class="form-label">Supplier *</label>
                <select id="modalSupplier" class="form-control">
                  <option value="">Pilih Supplier</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Item *</label>
                <select id="modalItem" class="form-control">
                  <option value="">Pilih Item</option>
                </select>
              </div>

              <div class="col-md-2">
                <label class="form-label">Qty *</label>
                <input type="number" id="modalQty" class="form-control" min="1" />
              </div>

              <div class="col-md-3">
                <button id="btnAddItem" class="btn btn-success w-100">+ Tambah Item</button>
              </div>
            </div>

            <hr />

            <!-- CART TABLE -->
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th>Harga</th>
                  <th>Qty</th>
                  <th>Subtotal</th>
                  <th width="100">Aksi</th>
                </tr>
              </thead>
              <tbody id="modalCartTable">
                <tr>
                  <td colspan="5" class="text-center">Belum ada item</td>
                </tr>
              </tbody>
            </table>

            <!-- GRAND TOTAL -->
            <div class="text-end mb-3">
              <h5>
                Grand Total:
                <strong id="modalGrandTotal">Rp 0</strong>
              </h5>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-primary" id="btnSubmitOrder">
              <span id="btnSubmitText">Simpan Order</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL DETAIL -->
    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detail Purchase Order</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <strong>Supplier:</strong> <span id="detailSupplier"></span><br />
              <strong>Tanggal:</strong> <span id="detailDate"></span>
            </div>
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th>Harga</th>
                  <th>Qty</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody id="detailItems"></tbody>
              <tfoot>
                <tr class="table-secondary">
                  <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                  <td><strong id="detailGrandTotal"></strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/app.js"></script>

    <script>
      let allPurchases = [];
      let filteredPurchases = [];
      let cart = [];
      let editMode = false;
      let editId = null;

      // Load suppliers
      function loadSuppliers() {
        apiRequest({
          url: "/supplier",
          success: (res) => {
            res.data.forEach((s) => {
              $("#filterSupplier").append(`<option value="${s.id}">${s.name}</option>`);
              $("#modalSupplier").append(`<option value="${s.id}">${s.name}</option>`);
            });
          },
        });
      }

      // Load items
      function loadItems() {
        apiRequest({
          url: "/item",
          success: (res) => {
            res.data.forEach((i) => {
              $("#modalItem").append(
                `<option value="${i.id}" data-price="${i.price}">${i.name}</option>`
              );
            });
          },
        });
      }

      // Load purchase data
      function loadPurchases() {
        apiRequest({
          url: "/purchasing",
          success: (res) => {
            allPurchases = res.data;
            filteredPurchases = allPurchases;
            renderTable();
          },
          error: () => {
            $("#purchaseTable").html(
              `<tr><td colspan="6" class="text-center text-danger">Gagal memuat data</td></tr>`
            );
          },
        });
      }

      // Render table
      function renderTable() {
        if (filteredPurchases.length === 0) {
          $("#purchaseTable").html(
            `<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>`
          );
          return;
        }

        let rows = "";
        filteredPurchases.forEach((p, index) => {
          const date = new Date(p.created_at).toLocaleDateString("id-ID");
          const totalItems = p.details ? p.details.length : 0;
          const grandTotal = p.details
            ? p.details.reduce((sum, d) => sum + d.qty * d.item.price, 0)
            : 0;

          rows += `
            <tr>
              <td>${index + 1}</td>
              <td>${date}</td>
              <td>${p.supplier ? p.supplier.name : "-"}</td>
              <td>${totalItems} item</td>
              <td>Rp ${grandTotal.toLocaleString()}</td>
              <td>
                <button class="btn btn-info btn-sm btn-detail" data-id="${p.id}">
                  Detail
                </button>
                <button class="btn btn-warning btn-sm btn-edit" data-id="${p.id}">
                  Edit
                </button>
                <button class="btn btn-danger btn-sm btn-delete" data-id="${p.id}">
                  Hapus
                </button>
              </td>
            </tr>
          `;
        });

        $("#purchaseTable").html(rows);
      }

      // Render cart in modal
      function renderCart() {
        let rows = "";
        let total = 0;

        if (cart.length === 0) {
          $("#modalCartTable").html(
            `<tr><td colspan="5" class="text-center">Belum ada item</td></tr>`
          );
          $("#modalGrandTotal").text("Rp 0");
          return;
        }

        cart.forEach((c, i) => {
          total += c.subtotal;

          rows += `
            <tr>
              <td>${c.item_name}</td>
              <td>Rp ${c.price.toLocaleString()}</td>
              <td>${c.qty}</td>
              <td>Rp ${c.subtotal.toLocaleString()}</td>
              <td>
                <button class="btn btn-danger btn-sm btn-delete-item" data-index="${i}">
                  Hapus
                </button>
              </td>
            </tr>
          `;
        });

        $("#modalCartTable").html(rows);
        $("#modalGrandTotal").text("Rp " + total.toLocaleString());
      }

      // Open create modal
      $("#btnCreate").click(function () {
        editMode = false;
        editId = null;
        cart = [];
        $("#formModalTitle").text("Buat Purchase Baru");
        $("#btnSubmitText").text("Simpan Order");
        $("#modalSupplier").val("");
        $("#modalItem").val("");
        $("#modalQty").val("");
        renderCart();
      });

      // Add item to cart
      $("#btnAddItem").click(function () {
        const itemId = parseInt($("#modalItem").val());
        const itemName = $("#modalItem option:selected").text();
        const price = parseInt($("#modalItem option:selected").data("price"));
        const qty = parseInt($("#modalQty").val());

        if (!itemId || !qty || qty <= 0) {
          Swal.fire("Error", "Pilih item & qty yang valid", "error");
          return;
        }

        cart.push({
          item_id: itemId,
          item_name: itemName,
          price: price,
          qty: qty,
          subtotal: price * qty,
        });

        $("#modalQty").val("");
        renderCart();
      });

      // Delete item from cart
      $("#modalCartTable").on("click", ".btn-delete-item", function () {
        const index = $(this).data("index");
        cart.splice(index, 1);
        renderCart();
      });

      // Submit order (create or update)
      $("#btnSubmitOrder").click(function () {
        const supplierId = parseInt($("#modalSupplier").val());

        if (!supplierId) {
          Swal.fire("Error", "Pilih supplier terlebih dahulu", "error");
          return;
        }

        if (cart.length === 0) {
          Swal.fire("Error", "Keranjang masih kosong", "error");
          return;
        }

        const payload = {
          supplier_id: supplierId,
          details: cart.map((i) => ({
            item_id: i.item_id,
            qty: i.qty,
          })),
        };

        if (editMode) {
          // Update
          apiRequest({
            url: `/purchasing/${editId}`,
            method: "PUT",
            data: payload,
            success: function () {
              Swal.fire("Success", "Order berhasil diupdate", "success");
              bootstrap.Modal.getInstance(document.getElementById("formModal")).hide();
              loadPurchases();
            },
          });
        } else {
          // Create
          apiRequest({
            url: "/purchasing",
            method: "POST",
            data: payload,
            success: function () {
              Swal.fire("Success", "Order berhasil disimpan", "success");
              bootstrap.Modal.getInstance(document.getElementById("formModal")).hide();
              loadPurchases();
            },
          });
        }
      });

      // Filter
      $("#btnFilter").click(function () {
        const supplierId = $("#filterSupplier").val();
        const filterDate = $("#filterDate").val();

        filteredPurchases = allPurchases.filter((p) => {
          let match = true;

          if (supplierId && p.supplier_id != supplierId) {
            match = false;
          }

          if (filterDate) {
            const pDate = new Date(p.created_at).toISOString().split("T")[0];
            if (pDate !== filterDate) {
              match = false;
            }
          }

          return match;
        });

        renderTable();
      });

      // Reset filter
      $("#btnReset").click(function () {
        $("#filterSupplier").val("");
        $("#filterDate").val("");
        filteredPurchases = allPurchases;
        renderTable();
      });

      // Show detail
      $("#purchaseTable").on("click", ".btn-detail", function () {
        const id = $(this).data("id");
        const purchase = allPurchases.find((p) => p.id === id);

        if (!purchase) return;

        $("#detailSupplier").text(purchase.supplier ? purchase.supplier.name : "-");
        $("#detailDate").text(new Date(purchase.created_at).toLocaleString("id-ID"));

        let itemRows = "";
        let total = 0;

        if (purchase.details) {
          purchase.details.forEach((d) => {
            const subtotal = d.qty * d.item.price;
            total += subtotal;

            itemRows += `
              <tr>
                <td>${d.item.name}</td>
                <td>Rp ${d.item.price.toLocaleString()}</td>
                <td>${d.qty}</td>
                <td>Rp ${subtotal.toLocaleString()}</td>
              </tr>
            `;
          });
        }

        $("#detailItems").html(itemRows);
        $("#detailGrandTotal").text("Rp " + total.toLocaleString());

        new bootstrap.Modal(document.getElementById("detailModal")).show();
      });

      // Edit
      $("#purchaseTable").on("click", ".btn-edit", function () {
        const id = $(this).data("id");
        const purchase = allPurchases.find((p) => p.id === id);

        if (!purchase) return;

        editMode = true;
        editId = id;
        cart = [];

        $("#formModalTitle").text("Edit Purchase Order");
        $("#btnSubmitText").text("Update Order");
        $("#modalSupplier").val(purchase.supplier_id);

        if (purchase.details) {
          purchase.details.forEach((d) => {
            cart.push({
              item_id: d.item_id,
              item_name: d.item.name,
              price: d.item.price,
              qty: d.qty,
              subtotal: d.qty * d.item.price,
            });
          });
        }

        renderCart();
        new bootstrap.Modal(document.getElementById("formModal")).show();
      });

      // Delete
      $("#purchaseTable").on("click", ".btn-delete", function () {
        const id = $(this).data("id");

        Swal.fire({
          title: "Hapus Purchase?",
          text: "Data yang dihapus tidak dapat dikembalikan",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Ya, Hapus!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            apiRequest({
              url: `/purchasing/${id}`,
              method: "DELETE",
              success: () => {
                Swal.fire("Terhapus!", "Data berhasil dihapus", "success");
                loadPurchases();
              },
            });
          }
        });
      });

      // Initial load
      loadSuppliers();
      loadItems();
      loadPurchases();
    </script>
  </body>
</html>