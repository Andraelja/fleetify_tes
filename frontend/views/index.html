<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleetify - Purchase Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            max-width: 400px;
            width: 100%;
        }
        
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .login-body {
            padding: 40px;
        }
        
        .app-container {
            display: none;
            padding: 20px;
        }
        
        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .card-custom {
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
            background: white;
        }
        
        .cart-item {
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            background: #f8f9fa;
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        
        .stock-badge {
            font-size: 0.85rem;
            padding: 5px 10px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .stat-card {
            border-left: 4px solid #667eea;
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="loginPage" class="auth-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-truck fa-3x mb-3"></i>
                <h3>Fleetify</h3>
                <p class="mb-0">Purchase Management System</p>
            </div>
            <div class="login-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input type="email" class="form-control" id="loginEmail" required 
                                   placeholder="admin@example.com" value="admin@gmail.com">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" class="form-control" id="loginPassword" required 
                                   placeholder="••••••••" value="admin123">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-gradient w-100 py-2">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container container-fluid">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-truck text-primary me-2"></i>
                    <strong>Fleetify</strong>
                </a>
                <div class="d-flex align-items-center">
                    <span class="me-3" id="userInfo"></span>
                    <button class="btn btn-outline-danger btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-page="dashboard">
                    <i class="fas fa-home me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="inventory">
                    <i class="fas fa-boxes me-2"></i>Inventory
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="purchase">
                    <i class="fas fa-shopping-cart me-2"></i>Create Purchase
                </a>
            </li>
        </ul>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card card-custom stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Total Items</h6>
                                    <h2 class="mb-0" id="totalItems">0</h2>
                                </div>
                                <div class="text-primary">
                                    <i class="fas fa-box fa-3x opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card card-custom stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Low Stock Items</h6>
                                    <h2 class="mb-0" id="lowStockItems">0</h2>
                                </div>
                                <div class="text-warning">
                                    <i class="fas fa-exclamation-triangle fa-3x opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card card-custom stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Total Purchases</h6>
                                    <h2 class="mb-0" id="totalPurchases">0</h2>
                                </div>
                                <div class="text-success">
                                    <i class="fas fa-shopping-cart fa-3x opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-custom">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Supplier</th>
                                    <th>Total</th>
                                    <th>Items</th>
                                </tr>
                            </thead>
                            <tbody id="recentPurchases">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventoryPage" class="page">
            <div class="card card-custom">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory Management</h5>
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInventory" placeholder="Search items...">
                    </div>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="inventoryLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Page -->
        <div id="purchasePage" class="page">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card card-custom">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add Items to Cart</h5>
                        </div>
                        <div class="card-body">
                            <form id="addItemForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Supplier</label>
                                        <select class="form-select" id="supplierSelect" required>
                                            <option value="">Select Supplier</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Purchase Date</label>
                                        <input type="date" class="form-control" id="purchaseDate" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Item</label>
                                        <select class="form-select" id="itemSelect" required>
                                            <option value="">Select Item</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="itemQty" min="1" required>
                                    </div>
                                    <div class="col-md-2 mb-3 d-flex align-items-end">
                                        <button type="submit" class="btn btn-gradient w-100">
                                            <i class="fas fa-plus me-1"></i>Add
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card card-custom">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Item Info</h5>
                        </div>
                        <div class="card-body" id="itemInfo">
                            <p class="text-muted">Select an item to see details</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-custom mt-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Shopping Cart</h5>
                    <button class="btn btn-sm btn-outline-danger" id="clearCartBtn">
                        <i class="fas fa-trash me-1"></i>Clear Cart
                    </button>
                </div>
                <div class="card-body">
                    <div id="emptyCart" class="empty-cart">
                        <i class="fas fa-shopping-cart fa-4x mb-3"></i>
                        <h5>Your cart is empty</h5>
                        <p>Add items to get started</p>
                    </div>
                    <div id="cartContent" style="display: none;">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Subtotal</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="cartTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <h4>Grand Total:</h4>
                            <h3 class="text-primary" id="grandTotal">Rp 0</h3>
                        </div>
                        <button class="btn btn-gradient btn-lg w-100 mt-3" id="submitOrderBtn">
                            <i class="fas fa-check me-2"></i>Submit Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // State Management
        const state = {
            token: localStorage.getItem('token') || null,
            user: JSON.parse(localStorage.getItem('user') || 'null'),
            cart: [],
            items: [],
            suppliers: []
        };

        // Reusable AJAX Wrapper
        function apiRequest(endpoint, options = {}) {
            const defaultOptions = {
                url: `${API_BASE_URL}${endpoint}`,
                headers: {}
            };

            if (state.token) {
                defaultOptions.headers['Authorization'] = `Bearer ${state.token}`;
            }

            const finalOptions = $.extend(true, defaultOptions, options);

            return $.ajax(finalOptions)
                .fail(function(xhr) {
                    handleApiError(xhr);
                });
        }

        // Error Handler
        function handleApiError(xhr) {
            let message = 'An error occurred';
            
            if (xhr.status === 401) {
                message = 'Session expired. Please login again.';
                logout();
            } else if (xhr.status === 404) {
                message = 'Resource not found';
            } else if (xhr.status === 500) {
                message = 'Server error. Please try again later.';
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                message = xhr.responseJSON.message;
            }

            showError(message);
        }

        // Toast Notifications
        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        function showLoading(message = 'Loading...') {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        // Auth Functions
        function login(email, password) {
            showLoading('Logging in...');
            
            apiRequest('/auth/login', {
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ email, password })
            }).done(function(response) {
                Swal.close();
                
                if (response.data && response.data.token) {
                    state.token = response.data.token;
                    state.user = response.data.user;
                    
                    localStorage.setItem('token', state.token);
                    localStorage.setItem('user', JSON.stringify(state.user));
                    
                    showSuccess('Login successful!');
                    showApp();
                    loadDashboard();
                } else {
                    showError('Invalid response from server');
                }
            });
        }

        function logout() {
            state.token = null;
            state.user = null;
            state.cart = [];
            
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            $('#loginPage').show();
            $('#appContainer').hide();
        }

        function showApp() {
            $('#loginPage').hide();
            $('#appContainer').show().css('display', 'block');
            $('#userInfo').text(`Welcome, ${state.user.name}`);
        }

        // Load Dashboard
        function loadDashboard() {
            apiRequest('/items').done(function(response) {
                const items = response.data || [];
                state.items = items;
                
                $('#totalItems').text(items.length);
                $('#lowStockItems').text(items.filter(i => i.stock < 10).length);
            });

            apiRequest('/purchasings').done(function(response) {
                const purchases = response.data || [];
                $('#totalPurchases').text(purchases.length);
                
                let html = '';
                purchases.slice(0, 5).forEach(p => {
                    html += `
                        <tr>
                            <td>${new Date(p.date).toLocaleDateString()}</td>
                            <td>${p.supplier ? p.supplier.name : 'N/A'}</td>
                            <td>Rp ${formatNumber(p.grand_total)}</td>
                            <td>${p.details ? p.details.length : 0} items</td>
                        </tr>
                    `;
                });
                
                $('#recentPurchases').html(html || '<tr><td colspan="4" class="text-center text-muted">No purchases yet</td></tr>');
            });
        }

        // Load Inventory
        function loadInventory() {
            $('#inventoryLoading').show();
            
            apiRequest('/items').done(function(response) {
                $('#inventoryLoading').hide();
                const items = response.data || [];
                state.items = items;
                renderInventory(items);
            });
        }

        function renderInventory(items) {
            let html = '';
            
            items.forEach(item => {
                const stockClass = item.stock < 10 ? 'text-danger' : item.stock < 50 ? 'text-warning' : 'text-success';
                const stockBadge = item.stock < 10 ? 'danger' : item.stock < 50 ? 'warning' : 'success';
                
                html += `
                    <tr>
                        <td>${item.id}</td>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.category || 'N/A'}</td>
                        <td>Rp ${formatNumber(item.price)}</td>
                        <td class="${stockClass}"><strong>${item.stock}</strong></td>
                        <td><span class="badge bg-${stockBadge}">${item.stock < 10 ? 'Low Stock' : 'Available'}</span></td>
                    </tr>
                `;
            });
            
            $('#inventoryTableBody').html(html || '<tr><td colspan="6" class="text-center text-muted">No items found</td></tr>');
        }

        // Load Purchase Data
        function loadPurchaseData() {
            apiRequest('/suppliers').done(function(response) {
                const suppliers = response.data || [];
                state.suppliers = suppliers;
                
                let html = '<option value="">Select Supplier</option>';
                suppliers.forEach(s => {
                    html += `<option value="${s.id}">${s.name}</option>`;
                });
                $('#supplierSelect').html(html);
            });

            apiRequest('/items').done(function(response) {
                const items = response.data || [];
                state.items = items;
                
                let html = '<option value="">Select Item</option>';
                items.forEach(i => {
                    html += `<option value="${i.id}" data-price="${i.price}" data-stock="${i.stock}">${i.name} (Stock: ${i.stock})</option>`;
                });
                $('#itemSelect').html(html);
            });

            $('#purchaseDate').val(new Date().toISOString().split('T')[0]);
        }

        // Cart Management
        function addToCart(itemId, qty) {
            const item = state.items.find(i => i.id === parseInt(itemId));
            
            if (!item) {
                showError('Item not found');
                return;
            }

            if (qty > item.stock) {
                showError(`Insufficient stock. Available: ${item.stock}`);
                return;
            }

            const existingIndex = state.cart.findIndex(c => c.item_id === parseInt(itemId));
            
            if (existingIndex >= 0) {
                state.cart[existingIndex].qty += parseInt(qty);
            } else {
                state.cart.push({
                    item_id: parseInt(itemId),
                    item: item,
                    qty: parseInt(qty)
                });
            }

            renderCart();
            showSuccess('Item added to cart');
            $('#addItemForm')[0].reset();
            $('#itemInfo').html('<p class="text-muted">Select an item to see details</p>');
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            renderCart();
            showSuccess('Item removed from cart');
        }

        function clearCart() {
            Swal.fire({
                title: 'Clear cart?',
                text: 'All items will be removed',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear it',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    state.cart = [];
                    renderCart();
                    showSuccess('Cart cleared');
                }
            });
        }

        function renderCart() {
            if (state.cart.length === 0) {
                $('#emptyCart').show();
                $('#cartContent').hide();
                return;
            }

            $('#emptyCart').hide();
            $('#cartContent').show();

            let html = '';
            let grandTotal = 0;

            state.cart.forEach((cartItem, index) => {
                const subtotal = cartItem.item.price * cartItem.qty;
                grandTotal += subtotal;

                html += `
                    <tr class="cart-item">
                        <td><strong>${cartItem.item.name}</strong></td>
                        <td>Rp ${formatNumber(cartItem.item.price)}</td>
                        <td>${cartItem.qty}</td>
                        <td>Rp ${formatNumber(subtotal)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-cart-item" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            $('#cartTableBody').html(html);
            $('#grandTotal').text(`Rp ${formatNumber(grandTotal)}`);
        }

        // Submit Order
        function submitOrder() {
            if (state.cart.length === 0) {
                showError('Cart is empty');
                return;
            }

            const supplierId = $('#supplierSelect').val();
            const purchaseDate = $('#purchaseDate').val();

            if (!supplierId || !purchaseDate) {
                showError('Please select supplier and date');
                return;
            }

            const payload = {
                date: purchaseDate,
                supplier_id: parseInt(supplierId),
                user_id: state.user.id,
                details: state.cart.map(c => ({
                    item_id: c.item_id,
                    qty: c.qty
                }))
            };

            Swal.fire({
                title: 'Submit Order?',
                text: `Total: Rp ${$('#grandTotal').text().replace('Rp ', '')}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, submit',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading('Submitting order...');

                    apiRequest('/purchasings', {
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload)
                    }).done(function(response) {
                        Swal.close();
                        showSuccess('Order submitted successfully!');
                        state.cart = [];
                        renderCart();
                        $('#addItemForm')[0].reset();
                        loadDashboard();
                    });
                }
            });
        }

        // Utility Functions
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        // Event Handlers
        $(document).ready(function() {
            // Check if already logged in
            if (state.token) {
                showApp();
                loadDashboard();
            }

            // Login Form
            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                const email = $('#loginEmail').val();
                const password = $('#loginPassword').val();
                login(email, password);
            });

            // Logout
            $('#logoutBtn').on('click', logout);

            // Navigation
            $('.nav-link').on('click', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                
                $('.page').removeClass('active');
                $(`#${page}Page`).addClass('active');

                // Load data based on page
                if (page === 'dashboard') {
                    loadDashboard();
                } else if (page === 'inventory') {
                    loadInventory();
                } else if (page === 'purchase') {
                    loadPurchaseData();
                }
            });

            // Item Select Change
            $('#itemSelect').on('change', function() {
                const selectedOption = $(this).find(':selected');
                const price = selectedOption.data('price');
                const stock = selectedOption.data('stock');
                
                if (price && stock !== undefined) {
                    $('#itemInfo').html(`
                        <div>
                            <p class="mb-2"><strong>Price:</strong> Rp ${formatNumber(price)}</p>
                            <p class="mb-0"><strong>Available Stock:</strong> <span class="${stock < 10 ? 'text-danger' : 'text-success'}">${stock}</span></p>
                        </div>
                    `);
                }
            });

            // Add Item Form
            $('#addItemForm').on('submit', function(e) {
                e.preventDefault();
                const itemId = $('#itemSelect').val();
                const qty = parseInt($('#itemQty').val());
                addToCart(itemId, qty);
            });

            // Event Delegation for Remove Cart Item
            $(document).on('click', '.remove-cart-item', function() {
                const index = $(this).